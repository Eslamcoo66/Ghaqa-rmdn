<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>دورة رمضانية – Master & Audience</title>
<style>
body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
h1 { text-align: center; }
.group { background: #fff; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background: #eee; }
input[type="number"] { width: 50px; }
button { padding: 5px 10px; margin-left: 5px; cursor: pointer; }
.hidden { display:none; }
#toggleButtons { text-align:center; margin-bottom:20px; }
</style>
</head>
<body>

<h1>دورة رمضانية</h1>

<div id="toggleButtons" class="hidden">
  <button onclick="showMode('master')">Master – إدارة النتائج</button>
  <button onclick="showMode('audience')">Audience – عرض النتائج</button>
</div>

<div id="masterView" class="hidden"></div>
<div id="audienceView"></div>

<script>
(function(){
  const MASTER_PASSWORD = "7890";
  const groupsData = {
    A: ["أصدقاء عبدالوهاب","شباب الشوكة","محلة كيل","أصدقاء حوش عيسي","شباب كوم البوص","الغراقة الغربية"],
    B: ["الشوكة الحاجر","الريف المصري","الصوالحية","اصدقاء محمد فؤاد","الزمالكاوية","البرنوجي"],
    E: ["ممتاز","كوم البوص","نجع العزايم","عزبة الست","أنصاف","أصدقاء اسامه الجارحي"],
    F: ["نجوم بطورس","الديابة","كوم القناطر","المحطة","الحريفة","الغراقة الشرقية"]
  };
  const storageKey = "ramadanLeagueData";
  let groups = {}, matches = {};

  // تحميل البيانات مع حماية
  try{
    const savedData = localStorage.getItem(storageKey);
    if(savedData){
      const parsed = JSON.parse(savedData);
      groups = parsed.groups || {};
      matches = parsed.matches || {};
    } else {
      for (let g in groupsData){
        groups[g]={}; matches[g]=[];
        for(let t of groupsData[g]) groups[g][t]={played:0,win:0,draw:0,loss:0,gf:0,ga:0,gd:0,points:0};
      }
    }
  }catch(e){
    console.error("خطأ في تحميل البيانات:",e);
    for (let g in groupsData){ groups[g]={}; matches[g]=[]; for(let t of groupsData[g]) groups[g][t]={played:0,win:0,draw:0,loss:0,gf:0,ga:0,gd:0,points:0}; }
  }

  let isMaster = false;
  if(window.location.search.includes("master")){
    try{
      const pw = prompt("ادخل كلمة سر الماستر:");
      if(pw===MASTER_PASSWORD){ 
        isMaster=true;
        document.getElementById("toggleButtons").classList.remove("hidden");
      } else alert("كلمة السر خطأ! سيتم فتح نسخة الجمهور.");
    }catch(e){}
  }

  const masterDiv = document.getElementById("masterView");
  const audienceDiv = document.getElementById("audienceView");

  // إنشاء الواجهات
  function createUI(){
    for(let g in groupsData){
      // Master
      if(isMaster){
        const div = document.createElement("div"); div.className="group";
        div.innerHTML = `<h2>المجموعة ${g}</h2>
        <table id="master-table-${g}"><thead><tr>
        <th>الفريق</th><th>لعب</th><th>فوز</th><th>تعادل</th><th>خسارة</th>
        <th>أهداف +</th><th>أهداف -</th><th>فارق الأهداف</th><th>نقاط</th>
        </tr></thead><tbody></tbody></table>
        <h4>أدخل نتيجة مباراة:</h4>
        <select id="team1-${g}"></select>
        <input type="number" id="score1-${g}" min="0" value="0">
        -
        <input type="number" id="score2-${g}" min="0" value="0">
        <select id="team2-${g}"></select>
        <button onclick="addMatch('${g}')">أضف النتيجة</button>
        <h4>المباريات المسجلة:</h4>
        <table id="matches-table-${g}"><thead>
        <tr><th>الفريق 1</th><th>الأهداف</th><th>الفريق 2</th><th>الأهداف</th><th>تعديل/حذف</th></tr>
        </thead><tbody></tbody></table>`;
        masterDiv.appendChild(div);

        const t1 = div.querySelector(`#team1-${g}`);
        const t2 = div.querySelector(`#team2-${g}`);
        for(let t of groupsData[g]){ t1.add(new Option(t,t)); t2.add(new Option(t,t)); }
      }

      // Audience
      const divA = document.createElement("div"); divA.className="group";
      divA.innerHTML = `<h2>المجموعة ${g}</h2>
      <table id="audience-table-${g}"><thead>
      <tr><th>الفريق</th><th>لعب</th><th>فوز</th><th>تعادل</th><th>خسارة</th>
      <th>أهداف +</th><th>أهداف -</th><th>فارق الأهداف</th><th>نقاط</th></tr>
      </thead><tbody></tbody></table>`;
      audienceDiv.appendChild(divA);
    }
    for(let g in groupsData){ renderGroup(g,'master'); renderMatches(g); renderGroup(g,'audience'); }
  }

  // إضافة/تعديل/حذف
  window.addMatch=function(group){
    try{
      const t1=document.getElementById(`team1-${group}`).value;
      const t2=document.getElementById(`team2-${group}`).value;
      const s1=parseInt(document.getElementById(`score1-${group}`).value)||0;
      const s2=parseInt(document.getElementById(`score2-${group}`).value)||0;
      if(t1===t2){ alert("لا يمكن اختيار نفس الفريق"); return; }
      matches[group].push({team1:t1,score1:s1,team2:t2,score2:s2});
      recalcGroup(group); saveData(); renderAll(); 
    }catch(e){ console.error("خطأ في إضافة المباراة:",e);}
  }

  function recalcGroup(group){
    try{
      for(let t in groups[group]) groups[group][t]={played:0,win:0,draw:0,loss:0,gf:0,ga:0,gd:0,points:0};
      for(let m of matches[group]){
        const {team1,score1,team2,score2}=m;
        const updateTeam=(team,win=0,draw=0,loss=0,gf=0,ga=0,pts=0)=>{
          const d=groups[group][team]; d.played+=1; d.win+=win; d.draw+=draw; d.loss+=loss; d.gf+=gf; d.ga+=ga; d.gd=d.gf-d.ga; d.points+=pts;
        }
        if(score1>score2){ updateTeam(team1,1,0,0,score1,score2,3); updateTeam(team2,0,0,1,score2,score1,0);}
        else if(score1<score2){ updateTeam(team1,0,0,1,score1,score2,0); updateTeam(team2,1,0,0,score2,score1,3);}
        else { updateTeam(team1,0,1,0,score1,score2,1); updateTeam(team2,0,1,0,score2,score1,1);}
      }
    }catch(e){console.error("خطأ في إعادة الحساب:",e);}
  }

  function saveData(){ try{ localStorage.setItem(storageKey,JSON.stringify({groups,matches})); }catch(e){console.error("خطأ في الحفظ:",e); } }

  window.renderGroup=function(group,mode='master'){
    try{
      const tbody=document.getElementById(`${mode}-table-${group}`).querySelector("tbody");
      const sorted=Object.keys(groups[group]).sort((a,b)=>{
        const x=groups[group][a],y=groups[group][b];
        if(y.points!==x.points) return y.points - x.points; // فرز تنازلي للنقاط
        return y.gd - x.gd; // فرز تنازلي لفارق الأهداف
      });
      tbody.innerHTML="";
      for(let t of sorted){
        const d=groups[group][t];
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${t}</td><td>${d.played}</td><td>${d.win}</td><td>${d.draw}</td><td>${d.loss}</td><td>${d.gf}</td><td>${d.ga}</td><td>${d.gd}</td><td>${d.points}</td>`;
        tbody.appendChild(tr);
      }
    }catch(e){console.error("خطأ في رسم الجدول:",e);}
  }

  window.renderMatches=function(group){
    if(!isMaster) return;
    try{
      const tbody=document.getElementById(`matches-table-${group}`).querySelector("tbody");
      tbody.innerHTML="";
      matches[group].forEach((m,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${m.team1}</td><td>${m.score1}</td><td>${m.team2}</td><td>${m.score2}</td>
        <td><button onclick="editMatch('${group}',${i})">تعديل</button>
        <button onclick="deleteMatch('${group}',${i})">حذف</button></td>`;
        tbody.appendChild(tr);
      });
    }catch(e){console.error("خطأ في رسم المباريات:",e);}
  }

  window.editMatch=function(group,index){
    try{
      const m=matches[group][index]; if(!m) return;
      const s1=prompt(`أدخل أهداف ${m.team1}:`,m.score1);
      const s2=prompt(`أدخل أهداف ${m.team2}:`,m.score2);
      if(s1!==null && s2!==null){ m.score1=parseInt(s1)||0; m.score2=parseInt(s2)||0; recalcGroup(group); saveData(); renderAll(); }
    }catch(e){console.error("خطأ في تعديل المباراة:",e);}
  }

  window.deleteMatch=function(group,index){
    try{
      if(confirm("هل تريد حذف هذه المباراة؟")){ matches[group].splice(index,1); recalcGroup(group); saveData(); renderAll(); }
    }catch(e){console.error("خطأ في حذف المباراة:",e);}
  }

  window.showMode=function(mode){ if(mode==='master'){ masterDiv.classList.remove('hidden'); audienceDiv.classList.add('hidden'); } else { masterDiv.classList.add('hidden'); audienceDiv.classList.remove('hidden'); } }

  function renderAll(){ for(let g in groupsData){ renderGroup(g,'master'); renderMatches(g); renderGroup(g,'audience'); } }

  // Storage event لتحديث الجمهور في تبويبات ثانية
  window.addEventListener('storage',(e)=>{ if(e.key===storageKey){ try{ const parsed=JSON.parse(e.newValue); groups=parsed.groups; matches=parsed.matches; renderAll(); }catch(err){console.error("خطأ تحديث الجمهور:",err);} }});

  // بدء الواجهة
  createUI();

})();
</script>

</body>
</html>